name: Android Build CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Create dummy local.properties
        run: touch local.properties

      # Жестко перезаписываем libs.versions.toml, чтобы использовать форк ktor
      - name: Force overwrite libs.versions.toml
        run: |
          cat > gradle/libs.versions.toml <<EOF
          [versions]
          minSdk = "24"
          targetSdk = "36"
          compileSdk = "36"

          agp = "8.13.2"
          cacheFix = "3.0.3"

          kotlin = "2.3.0"
          coroutines = "1.10.2"

          pydroid = "29.2.0"
          ktor = "3.3.3-PYAMSOFT"

          leakCanary = "2.14"
          timber = "5.0.1"

          qrCode = "4.5.0"
          dagger = "2.57.2"

          core = "1.17.0"
          activity = "1.12.2"
          lifecycle = "2.10.0"
          dataStore = "1.2.0"
          preference = "1.2.1"
          testRunner = "1.7.0"

          compose = "1.10.0"
          composeMaterial = "1.7.8"
          composeMaterial3 = "1.4.0"

          ksp = "2.3.4"

          coil = "3.3.0"

          spotless = "8.1.0"
          doctor = "0.12.1"
          jdkDesugar = "2.1.5"
          caupain = "1.7.1"


          [plugins]
          android = { id = "com.android.library", version.ref = "agp" }
          android-application = { id = "com.android.application", version.ref = "agp" }
          android-cacheFix = { id = "org.gradle.android.cache-fix", version.ref = "cacheFix" }

          compose-compiler = { id = "org.jetbrains.kotlin.plugin.compose", version.ref = "kotlin"}

          kotlin-android = { id = "org.jetbrains.kotlin.android", version.ref = "kotlin" }

          ksp = { id = "com.google.devtools.ksp", version.ref = "ksp" }

          spotless = { id = "com.diffplug.spotless", version.ref = "spotless" }
          doctor = { id = "com.osacky.doctor", version.ref = "doctor" }
          caupain = { id = "com.deezer.caupain", version.ref = "caupain" }

          [libraries]
          android-desugar = { group = "com.android.tools", name = "desugar_jdk_libs", version.ref = "jdkDesugar" }

          androidx-activity-compose = { group = "androidx.activity", name = "activity-compose", version.ref = "activity" }
          androidx-core-ktx = { group = "androidx.core", name = "core-ktx", version.ref = "core" }
          androidx-dataStore = { group = "androidx.datastore", name = "datastore-preferences", version.ref = "dataStore" }
          androidx-lifecycle-compose = { group = "androidx.lifecycle", name = "lifecycle-runtime-compose", version.ref = "lifecycle" }
          androidx-preference = { group = "androidx.preference", name = "preference", version.ref = "preference" }
          androidx-testRunner = { group = "androidx.test", name = "runner", version.ref = "testRunner" }

          compose-animation = { group = "androidx.compose.animation", name = "animation", version.ref = "compose" }
          compose-material-icons = { group = "androidx.compose.material", name = "material-icons-core", version.ref = "composeMaterial" }
          compose-material-icons-extended = { group = "androidx.compose.material", name = "material-icons-extended", version.ref = "composeMaterial" }
          compose-material3 = { group = "androidx.compose.material3", name = "material3", version.ref = "composeMaterial3" }
          compose-runtime-annotation = { group = "androidx.compose.runtime", name = "runtime-annotation", version.ref = "compose" }
          compose-ui = { group = "androidx.compose.ui", name = "ui", version.ref = "compose" }
          compose-ui-tooling = { group = "androidx.compose.ui", name = "ui-tooling", version.ref = "compose" }
          compose-ui-tooling-preview = { group = "androidx.compose.ui", name = "ui-tooling-preview", version.ref = "compose" }

          coil-compose = { group = "io.coil-kt.coil3", name = "coil-compose-core", version.ref = "coil" }

          dagger = { group = "com.google.dagger", name = "dagger", version.ref = "dagger" }
          dagger-compiler = { group = "com.google.dagger", name = "dagger-compiler", version.ref = "dagger" }

          kotlin-test = { group = "org.jetbrains.kotlin", name = "kotlin-test", version.ref = "kotlin" }
          kotlinx-coroutines = { group = "org.jetbrains.kotlinx", name = "kotlinx-coroutines-core", version.ref = "coroutines" }
          kotlinx-coroutines-test = { group = "org.jetbrains.kotlinx", name = "kotlinx-coroutines-test", version.ref = "coroutines" }

          ktor-network = { group = "com.github.pyamsoft.ktor", name = "ktor-network", version.ref = "ktor" }
          ktor-server-netty = { group = "com.github.pyamsoft.ktor", name = "ktor-server-netty-jvm", version.ref = "ktor" }

          leakcanary = { group = "com.squareup.leakcanary", name = "leakcanary-android", version.ref = "leakCanary" }
          leakcanary-plumber = { group = "com.squareup.leakcanary", name = "plumber-android", version.ref = "leakCanary" }

          pydroid-bus = { group = "com.github.pyamsoft.pydroid", name = "bus", version.ref = "pydroid" }
          pydroid-notify = { group = "com.github.pyamsoft.pydroid", name = "notify", version.ref = "pydroid" }
          pydroid-ui = { group = "com.github.pyamsoft.pydroid", name = "ui", version.ref = "pydroid" }
          pydroid-util = { group = "com.github.pyamsoft.pydroid", name = "util", version.ref = "pydroid" }

          qrcode = { group = "io.github.g0dkar", name = "qrcode-kotlin-android", version.ref = "qrCode" }

          timber = { group = "com.jakewharton.timber", name = "timber", version.ref = "timber" }
          EOF

      # Жестко перезаписываем build.gradle, добавляя правильные репозитории и стратегию разрешения зависимостей
      - name: Force overwrite root build.gradle
        run: |
          cat > build.gradle <<EOF
          import com.deezer.caupain.model.StabilityLevelPolicy
          import com.deezer.caupain.plugin.DependenciesUpdateTask

          plugins {
            alias(libs.plugins.android) apply false
            alias(libs.plugins.android.cacheFix) apply false
            alias(libs.plugins.kotlin.android) apply false
            alias(libs.plugins.compose.compiler) apply false
            alias(libs.plugins.spotless) apply false
            alias(libs.plugins.ksp) apply false
            alias(libs.plugins.doctor) apply true
            alias(libs.plugins.caupain) apply true
          }

          allprojects {
            apply(plugin: libs.plugins.spotless.get().pluginId)

            repositories {
              mavenLocal()
              gradlePluginPortal()
              google()
              mavenCentral()

              maven {
                setUrl("https://jitpack.io")
                content {
                  includeGroup("com.github.pyamsoft.cachify")
                  includeGroup("com.github.pyamsoft.pydroid")
                  includeGroup("com.github.pyamsoft")
                  includeGroup("com.github.pyamsoft.ktor")
                }
              }
            }

            configurations.all {
                resolutionStrategy {
                    eachDependency { details ->
                        if (details.requested.group == 'io.ktor' && details.requested.name == 'ktor-network') {
                            details.useTarget group: 'com.github.pyamsoft.ktor', name: 'ktor-network', version: '3.3.3-PYAMSOFT'
                        }
                        if (details.requested.group == 'io.ktor' && details.requested.name == 'ktor-server-netty-jvm') {
                            details.useTarget group: 'com.github.pyamsoft.ktor', name: 'ktor-server-netty-jvm', version: '3.3.3-PYAMSOFT'
                        }
                    }
                }
            }

            spotless {
              java {
                target("src/**/*.java")

                removeUnusedImports()
                trimTrailingWhitespace()
                endWithNewline()
                leadingTabsToSpaces(2)
              }
              kotlin {
                target("src/**/*.kt")
                ktfmt()

                trimTrailingWhitespace()
                endWithNewline()
                leadingTabsToSpaces(2)
              }
              kotlinGradle {
                target("*.gradle.kts")
                ktfmt()

                trimTrailingWhitespace()
                endWithNewline()
                leadingTabsToSpaces(2)
              }
              groovyGradle {
                target("*.gradle")
                greclipse()

                trimTrailingWhitespace()
                endWithNewline()
                leadingTabsToSpaces(2)
              }
            }

            tasks.withType(DependenciesUpdateTask).configureEach {
              selectIf(StabilityLevelPolicy.INSTANCE)
            }
          }

          subprojects {
            tasks.withType(JavaCompile).configureEach {
              options.compilerArgs.add("-Xlint:unchecked")
              options.compilerArgs.add("-Xlint:deprecation")
              options.deprecation = true
            }
          }
          EOF

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew :app:assembleDebug --no-configuration-cache

      - name: Run Unit Tests
        run: ./gradlew :app:testDebugUnitTest --no-configuration-cache

      - name: Upload Debug APKs
        uses: actions/upload-artifact@v4
        with:
          name: debug-apks
          path: app/build/outputs/apk/*/debug/*.apk
          if-no-files-found: error